---
title: "pbmc dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
library(dplyr)
library(Seurat)
library(patchwork)
```

```{r}
pbmc.data<-Read10X(data.dir="/filtered_gene_bc_matrices/hg19")
head(pbmc.data)
```
```{r}
pbmc<-CreateSeuratObject(counts=pbmc.data,project = "pbmc3k",min.cells =3 ,min.features = 200)
pbmc
```
```{r}
pbmc[["percent.mt"]]<- PercentageFeatureSet(pbmc,pattern="^MT-")
```

**QC metrics are stored in meta.data**

```{r}
head(pbmc@meta.data)
```
```{r}
summary(pbmc@meta.data$nFeature_RNA)
```
```{r}
hist(pbmc@meta.data$nFeature_RNA,breaks=100)
abline(v=2500,col="red")
abline(v=200,col="blue")
#We filter cells that have unique feature counts over 2,500 or less than 200
```

```{r}
summary(pbmc@meta.data$nCount_RNA)
```
```{r}
hist(pbmc@meta.data$nCount_RNA,breaks=100)
```
```{r}
summary(pbmc@meta.data$percent.mt)
```
```{r}
hist(pbmc@meta.data$percent.mt,breaks=100)
abline(v=5,col="red")
#We filter cells that have >5% mitochondrial counts
```
**Violin Plot of QC metrics**

```{r}
VlnPlot(pbmc,features = c("nCount_RNA","nFeature_RNA","percent.mt"),ncol=3)
```
**High positive correlation b/w nCount_RNA & nFeature_RNA**
```{r}
plot1<-FeatureScatter(pbmc,feature="nCount_RNA",feature2 = "percent.mt")
plot2<-FeatureScatter(pbmc,feature1="nCount_RNA",feature2 = "nFeature_RNA")
plot1+plot2
```
```{r}
plot3<-FeatureScatter(pbmc,feature1 = "nFeature_RNA",feature2 = "percent.mt")
plot3
```
**Filtering of cells by removing outliers**

```{r}
pbmc<-subset(pbmc,subset=nFeature_RNA>200 & nFeature_RNA<2500 & percent.mt<5)
```

**Normalizing the data**

```{r}
pbmc<-NormalizeData(pbmc,normalization.method = "LogNormalize",scale.factor = 10000)
#normalized data is stored in data slot of "RNA"
```
**Identification of highly variable features (feature selection)**

```{r}
#focusing on highly variable genes (that exhibit high cell to cell variation) in downstream analysis helps in detection of biological signal 
pbmc<-FindVariableFeatures(pbmc,selection.method = "vst",nfeatures = 2000)
pbmc

```
**Plot variable features**
```{r}
top10<-head(VariableFeatures(pbmc),10)
plot1<-VariableFeaturePlot(pbmc)
plot2<-LabelPoints(plot=plot1,points=top10,repel=TRUE)
plot1
```

```{r}
plot2
```
**Scaling the data**

```{r}
#Shifts the expression of each gene, so that the mean expression across cells is 0

#Scales the expression of each gene, so that the variance across cells is 1

all.genes<-rownames(pbmc)
pbmc<-ScaleData(pbmc,features = all.genes)
```
**Perform Linear dimensional Reduction**

```{r}
pbmc<-RunPCA(pbmc,features = VariableFeatures(object=pbmc))
```
```{r}
print(pbmc[["pca"]],dims=1:5,nfeatures=5)
```
**Visualize top genes associated with reduction components**

```{r}
VizDimLoadings(pbmc,dims=1:2,reduction = "pca")
```
**Graphs the output of a dimensional reduction technique on a 2D scatter plot where each point is a cell and it's positioned based on the cell embeddings determined by the reduction technique.**

```{r}
DimPlot(object=pbmc,reduction = "pca")
```
```{r}
DimHeatmap(pbmc,cells = 500,balanced = TRUE)

#for easy exploration of the primary sources of heterogeneity in a dataset, and can be useful when trying to decide which PCs to include for further downstream analyses. Both cells and features are ordered according to their PCA scores. 
```

```{r}
DimHeatmap(pbmc,dims=1:15,cells=500,balanced = TRUE)
```
**Determine the 'dimensionality' of the dataset**

```{r}
pbmc<-JackStraw(pbmc,num.replicate = 100)

#JackStraw() randomly permutes a subset of data, and calculates projected PCA scores for these 'random' genes. Then compares the PCA scores for the 'random' genes with the observed PCA scores to determine statistical signifance. End result is a p-value for each gene's association with each principal component.
pbmc<-ScoreJackStraw(pbmc,dims=1:20)

```

```{r}
JackStrawPlot(pbmc,dims = 1:15)

#The JackStrawPlot function provides a visualization tool for comparing the distribution of p-values for each PC with a uniform distribution (dashed line). 

#'Significant' PCs will show a strong enrichment of features with low p-values (solid curve above the dashed line). In this case it appears that there is a sharp drop-off in significance after the first 10-12 PCs.

```
```{r}
ElbowPlot(pbmc)

#An alternative heuristic method generates an 'Elbow plot': a ranking of principle components based on the percentage of variance explained by each one (ElbowPlot function). 

#In this example, we can observe an 'elbow' around PC9-10, suggesting that the majority of true signal is captured in the first 10 PCs.
```
```{r}
pbmc<-FindNeighbors(pbmc,dims=1:10)
pbmc<-FindClusters(pbmc,resolution = 0.5)
```
```{r}
head(Idents(pbmc),5)
```
**Run non-linear dimensional reduction (UMAP/tSNE)**

```{r}
pbmc<-RunUMAP(pbmc,dims=1:10)
```

```{r}
DimPlot(pbmc,reduction = "umap",label=TRUE)
```
```{r}
#find all markers of cluster 1
cluster1.markers <- FindMarkers(pbmc, ident.1 = 1, min.pct = 0.25)
head(cluster1.markers, n = 5)
```
```{r}
# find all markers distinguishing cluster 5 from clusters 0 and 3
cluster5.markers <- FindMarkers(pbmc, ident.1 = 5, ident.2 = c(0, 3), min.pct = 0.25)
head(cluster5.markers, n = 5)
```
```{r}
# find markers for every cluster compared to all remaining cells, report only the positive ones
pbmc.markers <- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
pbmc.markers %>% group_by(cluster) %>% top_n(n = 2, wt = avg_logFC)
```
```{r}
cluster1.markers<-FindMarkers(pbmc,ident.1=1,logfc.threshold = 0.25,test.use = "roc",only.pos = TRUE)
```
```{r}
VlnPlot(pbmc, features = c("MS4A1", "CD79A"))

```
```{r}
# you can plot raw counts as well
VlnPlot(pbmc, features = c("NKG7", "PF4"), slot = "counts", log = TRUE)
```

```{r}
FeaturePlot(pbmc, features = c("MS4A1", "GNLY", "CD3E", "CD14", "FCER1A", "FCGR3A", "LYZ", "PPBP", 
    "CD8A"),combine=FALSE)
```
```{r}
top10<-pbmc.markers%>%group_by(cluster)%>%top_n(n=10,wt=avg_logFC)
DoHeatmap(pbmc,features = top10$gene)+NoLegend()
```
**Assigning cell type identity to clusters**

```{r}
new.cluster.ids <- c("Naive CD4 T", "Memory CD4 T", "CD14+ Mono", "B", "CD8 T", "FCGR3A+ Mono", 
    "NK", "DC", "Platelet")
names(new.cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, new.cluster.ids)

DimPlot(pbmc, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
```
```{r}
saveRDS(pbmc,file="pbmc3k_final.rds")
```

